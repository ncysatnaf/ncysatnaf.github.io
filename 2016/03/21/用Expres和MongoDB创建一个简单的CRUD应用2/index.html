<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 用Expres和MongoDB创建一个简单的CRUD应用 —— （ 2 ） · Vai</title><meta name="description" content="用Expres和MongoDB创建一个简单的CRUD应用 —— （ 2 ） - null"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/ncysatnaf" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">用Expres和MongoDB创建一个简单的CRUD应用 —— （ 2 ）</h1><div class="post-time">Mar 21, 2016</div><div class="post-content"><h2 id="CRUD-CREATE"><a href="#CRUD-CREATE" class="headerlink" title="CRUD - CREATE"></a>CRUD - CREATE</h2><p>CREATE 操作只有当浏览器发出一个POST请求时才会执行。POST请求可以通过JS或者<code>&lt;from&gt;</code>元素发出.</p>
<p>让我们先尝试如何使用<code>&lt;form&gt;</code>元素发出吧，如此，必须得先在<code>index.html</code>里创建一个<code>&lt;form&gt;</code>元素，你需要做三件事。</p>
<ol>
<li>一个<code>action</code>属性</li>
<li>一个<code>method</code>属性</li>
<li>所有在form元素里的<code>&lt;input&gt;</code>元素的<code>name</code>属性。<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/quotes"</span> <span class="attr">method</span>=<span class="string">"POST"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">placeholder</span>=<span class="string">"name"</span> <span class="attr">name</span>=<span class="string">"name"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">placeholder</span>=<span class="string">"quote"</span> <span class="attr">name</span>=<span class="string">"quote"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span>Submit<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><code>action</code>属性告诉浏览器请求要发到哪儿.在这里我们发送到<code>/quotes</code>。<br><code>method</code>属性告诉浏览器我们要发送那种请求。在这里我们发送POST请求。</p>
<p>在我们的服务端,我们可以使用Express痛的<code>post</code>方法处理POST请求.它有点类似GET方法。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.post(<span class="string">'/quotes'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Hellooooooooooooooooo!'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>惯例重启服务器并刷新网页,在<code>from</code>元素内输入字符并点击<code>submit</code>,你应该就可以看到<code>Helloooooooooo!</code>出现在你的命令行。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ node server.js</span><br><span class="line">listening on 3000</span><br><span class="line">Helloooooooooo!</span><br></pre></td></tr></table></figure></p>
<p>好样的，我们现在知道了Express如何处理from了,接下来的问题是：我们如何使用Express得到传过来的值？</p>
<p>结果是，Express本身无法读取并处理<code>&lt;form&gt;</code>元素，我们可以添加一个叫<a href="https://www.npmjs.com/package/body-parser" target="_blank" rel="external">body-parser</a>的模块实现这个功能。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install body-parser --save</span><br></pre></td></tr></table></figure>
<p>Express允许我们添加类似body-parser这样的中间件到我们的应用中来。我们使用<code>use</code>方法来加载它们。确保在处理应用逻辑之前加载它们。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">const</span> bodyParser= <span class="built_in">require</span>(<span class="string">'body-parser'</span>)</span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"></span><br><span class="line">app.use(bodyParser.urlencoded(&#123;extended: <span class="literal">true</span>&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment">// All your handlers here...</span></span><br></pre></td></tr></table></figure></p>
<p><code>urlencoded</code>方法告诉body-parser从<code>request</code>对象的<code>&lt;form&gt;</code>元素中的<code>body</code>原型获取数据.</p>
<p>现在，你可以尝试使用<code>console.log</code>来查看<code>req.body</code>对象的内容。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.post(<span class="string">'/quotes'</span>, (req,res) =&gt; &#123;</span><br><span class="line">true<span class="built_in">console</span>.log(req.body)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>然后发送一个请求，你就可以在命令行看到它作为一个对象被打印出来。</p>
<p>接下来就是数据库了，MongoDB。</p>
<h2 id="MongoDB"><a href="#MongoDB" class="headerlink" title="MongoDB"></a>MongoDB</h2><p>我们如果想要使用MongoDb,首先得通过npm安装Mongodb它。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install mongodb --save</span><br></pre></td></tr></table></figure></p>
<p>安装完后，我们通过Mongo.Client的连接它，他的代码长这样。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> MongoClient = <span class="built_in">require</span>(<span class="string">'mongodb'</span>).MongoClient</span><br><span class="line"></span><br><span class="line">MongoClient.connect(<span class="string">'link-to-mongodb'</span>, (err, database) =&gt; &#123;</span><br><span class="line">  <span class="comment">// ... start the server</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>下一步我们需要给我们的数据库一个合适的链接，许多人使用像<a href="https://mongolab.com/" target="_blank" rel="external">MongoLab</a>这样的云服务，我们也可以这样。</p>
<p>那么.创建一个MongoLab账号(免费)，之后创建一个新的MongoDB配置并设置为<code>sandbox</code>方案。<br>完毕之后，进入配置中心创建一个数据库用户和数据库密码。(保存好它们)因为我们连接数据库的时候还需要它们。</p>
<p>最后，将你的MongoDB地址添加到<code>MongoClient.connect</code>方法中,确定用户和密码。</p>
<p>接下来，我们想让我们的服务器仅仅在数据区已经链接的情况下才穷。 让我们将<code>app.listen</code>一到<code>connect</code>方法里面。我们需要先创建一个<code>db</code>变量来允许我们使用数据库。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> db</span><br><span class="line"></span><br><span class="line">MongoClient.connect(<span class="string">'your-mongodb-url'</span>, (err, database) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="built_in">console</span>.log(err)</span><br><span class="line">  db = database</span><br><span class="line">  app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'listening on 3000'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>我们对MongoDB做了一些设定。让我们创建一个<code>quote</code>collection来存储我们引用的quotes</p>
<p>我们可以在MongoDB的db.collection(‘quotes’)方法,创建完毕后我们可以对其使用<code>save</code>方法来保存数据。</p>
<p>保存后，我们还可以重定向浏览器，这里我们将重定向到<code>/</code>,这里浏览器后重新加载。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">app.post(<span class="string">'/quotes'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  db.collection(<span class="string">'quotes'</span>).save(req.body, (err, result) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="built_in">console</span>.log(err)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'saved to database'</span>)</span><br><span class="line">    res.redirect(<span class="string">'/'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>酷，我们输入了一些quotes到collection，为什么不把他们显示到我们的页面上呢。</p>
<h2 id="显示Quotes"><a href="#显示Quotes" class="headerlink" title="显示Quotes"></a>显示Quotes</h2><p>要显示我们MongoLab中的quotes,我们有两件事情要做.</p>
<ol>
<li>从MongoLab中拿到quotes</li>
<li>使用模板引擎显示quotes</li>
</ol>
<p>让我们尝试一下。</p>
<p>我们可以通过<code>find</code>方法从<code>collection</code>中拿到quotes<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">var</span> cursor = db.collection(<span class="string">'quotes'</span>).find()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>我们可以使用<a href="http://www.embeddedjs.com/" target="_blank" rel="external">Embedded</a>(ejs）模板引擎来作为我们的模板引擎。<br>首先安装它<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm isntall ejs --save</span><br></pre></td></tr></table></figure></p>
<p>然后使用<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'ejs'</span>)</span><br></pre></td></tr></table></figure></p>
<p>这样我们的模板引擎就设置好了，我们可以开始生成我们quotes的HTMl了。这个过程我们通常称之为<strong>rendering</strong>，我们可以在<code>response</code>对象中使用<code>render</code>对象。像是这样<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res.render(view, locals)</span><br></pre></td></tr></table></figure></p>
<p>让我们来创建一个views文件夹，并在里面创建一个<code>index.ejs</code>文件。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir views</span><br><span class="line">touch views/index.ejs</span><br></pre></td></tr></table></figure></p>
<p>将下面代码添加进<code>index.ejs</code><br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;ul class="quotes"&gt;</span><br><span class="line">  &lt;% for(var i=0; i&lt;quotes.length; i++) &#123;%&gt;</span><br><span class="line">    &lt;li class="quote"&gt;</span><br><span class="line">      &lt;span&gt;&lt;%= quotes[i].name %&gt;&lt;/span&gt;</span><br><span class="line">      &lt;span&gt;&lt;%= quotes[i].quote %&gt;&lt;/span&gt;</span><br><span class="line">    &lt;/li&gt;</span><br><span class="line">  &lt;% &#125; %&gt;</span><br><span class="line">&lt;/ul&gt;</span><br></pre></td></tr></table></figure></p>
<p>最后，当处理GET请求时，我们开始渲染<code>index.ejs</code>文件。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  db.collection(<span class="string">'quotes'</span>).find().toArray((err, result) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="built_in">console</span>.log(err)</span><br><span class="line">    <span class="comment">// renders index.ejs</span></span><br><span class="line">    res.render(<span class="string">'index.ejs'</span>, &#123;quotes: result&#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>嗯哼，教程到这里就结束了。只是一个很简单的应用。你可以将它扩展尝试更多玩法。</p>
<p>教程翻译自<a href="http://zellwk.com/blog/crud-express-mongodb/" target="_blank" rel="external">http://zellwk.com/blog/crud-express-mongodb/</a></p>
<p>此文章仅作为个人学习用。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/03/20/用Expres和MongoDB创建一个简单的CRUD应用1/" class="next">NEXT</a></div><div data-thread-key="2016/03/21/用Expres和MongoDB创建一个简单的CRUD应用2/" data-title="用Expres和MongoDB创建一个简单的CRUD应用 —— （ 2 ）" data-url="www.ysatnaf.com/2016/03/21/用Expres和MongoDB创建一个简单的CRUD应用2/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"ysatnaf"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2016 <a href="www.ysatnaf.com"></a>, unless otherwise noted.</p></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?a36e15d9e2adec9a21fcdd9f686b1ed2";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>